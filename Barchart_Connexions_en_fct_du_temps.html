<!DOCTYPE html>
<head>

  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <style>
    h1 {
      margin: 0px 0px 15px 20px;
      font-family: 'Arial';
    }

    .bar {
      fill: steelblue;
    }

    .bar:hover {
      fill: blue;
    }

    .label {
      fill: black;
      font: 10px sans-serif;
    }

    .y path, .y stroke, .y line {
      display: none;
    }

    .x path, .x stroke {
      display: none;
    }

  </style>

</head>

<body>
<h1>Nombre de connexions en fonction du temps</h1>
<select id="d3-dropdown" onchange="resort(this)">
  <option value="1">Alphabetique ASC</option>
  <option value="2">Alphabetique DESC</option>
  <option value="3">Frequence ASC</option>
  <option value="4">Frequence DESC</option>
</select>
<script>

  var margin = {
    top: 20,
    right: 20,
    bottom: 20,
    left: 20
  };
  var width = 1000 - margin.left - margin.right;
  var height = 500 - margin.top - margin.bottom;

  var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scaleLinear()
    .range([0, width]);

  var y = d3.scaleBand()
    .range([0, height]);

  var xAxis = d3.axisTop(x);

  var yAxis = d3.axisLeft(y);

  var tabHours = [24]
  allConnections = 0;

  for (i=0;i<24;i++){
    tabHours[i]={
      hours: i,
      frequency: 0
    }
  }

  d3.csv("dataParisHotspotslight.csv")
    .then(function(data) {
      var datetime = d3.timeParse("%Y-%m-%dT%H:%M:%S%Z");

      data.forEach(function(obj,i) {
        DateDebut = datetime(obj.DateDebut)
        DateDebutHours = DateDebut.getHours();

        tabHours[DateDebutHours].frequency += 1;
        allConnections+=1;
      });
    })
    .then(function() {
      var maxFrequency = d3.max(tabHours, function(d) { return d.frequency});
      x.domain([0, maxFrequency]);

      y.domain(tabHours.map(function(d) { return d.hours; }))
        .paddingInner(0.1);

      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + -2 + ")")
        .call(xAxis);

      var gy = svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

      var bar = svg.selectAll(".bar")
        .data(tabHours)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", function(d,i) { return d.hours+17.8*i; })
        .attr("width", function(d) { return x(d.frequency); });

      Object.assign(svg, {
        update(sorttype) {
          y.domain(tabHours.sort(sorttype).map(d => d.hours));

          const t = svg.transition()
            .duration(500);

          bar.data(tabHours, d => d.hours)
            .order()
            .transition()
            .duration(500)
            .attr("y", d => y(d.hours));

          gy.call(yAxis);
        }
      });
    });

  function resort(element){
    switch(element.value){
      case "1":
        svg.update((a,b) =>d3.ascending(a.hours, b.hours));
        break;
      case "2":
        svg.update((a,b) =>d3.descending(a.hours, b.hours));
        break;
      case "3":
        svg.update((a,b) =>d3.ascending(a.frequency, b.frequency));
        break;
      case "4":
        svg.update((a,b) =>d3.descending(a.frequency, b.frequency));
        break;
    }
  }


</script>
